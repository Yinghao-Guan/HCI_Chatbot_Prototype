<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ strings.title }}</title>
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="manifest" href="/assets/site.webmanifest" />

    <style>
        /* --- CSS Styles (Consistent look) --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100%;
            padding: 40px 20px;
            box-sizing: border-box;
            max-width: 800px;
            margin: 0 auto;
        }

        .form-section {
            background: #ffffff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .form-section h1 {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
        }

        .form-section p.intro {
            text-align: center;
            margin-bottom: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .question-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
        }

        .radio-group div {
             display: flex; /* Align radio and label */
             align-items: center;
             margin-bottom: 10px;
        }
        .radio-group input[type="radio"] {
             margin-right: 10px; /* Space between radio and label */
        }
        .radio-group label {
             margin-bottom: 0; /* Override default label margin */
             font-weight: normal; /* Normal weight for options */
             color: #555;
        }


        /* --- Privacy/Contact Section --- */
        #contact-section {
            padding: 20px;
            border: 1px solid #ccc; /* Less prominent border */
            border-radius: 8px;
            margin-top: 30px;
            background-color: #f9f9f9; /* Lighter background */
            display: none; /* Default hidden */
        }

        #contact-section p {
            font-size: 0.9rem; /* Smaller privacy note */
            color: #666; /* Grey text */
            margin-top: 15px;
            line-height: 1.5;
        }
        #contact-section label {
            margin-bottom: 8px; /* Standard label margin */
        }
        #contact-section input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }


        /* Button styling */
        .btn-submit {
            display: block;
            width: 100%;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background-color: #1abc9c; /* Teal/Green for final questions */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 40px;
        }

        .btn-submit:hover {
            background-color: #16a085;
        }

        .btn-submit:disabled {
            background-color: #a0c3e8;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
        }

         /* --- (NEW) Error Highlighting --- */
        .input-error {
            border-color: #e74c3c !important; /* Red border */
            background-color: #fcecec; /* Light red background */
        }
        .label-error {
            color: #e74c3c !important; /* Red label text */
        }
         /* Style for radio group container when error */
        .form-group.group-error .radio-group {
             /* Optional: Add a subtle background or border to the group */
             /* background-color: #fcecec; */
             padding: 10px;
             border-radius: 4px;
             border: 1px dashed #e74c3c;
        }

    </style>
</head>
<body>

<div class="main-container">
    <div class="form-section">
        <h1>{{ strings.title }}</h1>
        <p class="intro">{{ strings.intro | safe }}</p>

        <form id="open-ended-form">
            <div class="form-group">
                <label for="feedback_trust" class="question-label">{{ strings.q1_trust | safe }}</label>
                <textarea id="feedback_trust" name="feedback_trust" rows="4" placeholder="Your thoughts here..."></textarea>
            </div>

            <div class="form-group">
                <label for="feedback_empathy" class="question-label">{{ strings.q2_empathy | safe }}</label>
                <textarea id="feedback_empathy" name="feedback_empathy" rows="4" placeholder="Your thoughts here..."></textarea>
            </div>

            <div class="form-group">
                <label for="feedback_general" class="question-label">{{ strings.q3_general }}</label>
                <textarea id="feedback_general" name="feedback_general" rows="4" placeholder="Your thoughts here..."></textarea>
            </div>

            <div class="form-group"> <label class="question-label">{{ strings.q4_interview }}</label> <div class="radio-group">
                    <div><input type="radio" id="interview_yes" name="interview_consent" value="Yes" required><label for="interview_yes">{{ strings.q4_yes }}</label></div>
                    <div><input type="radio" id="interview_no" name="interview_consent" value="No"><label for="interview_no">{{ strings.q4_no }}</label></div>
                </div>
            </div>

            <div id="contact-section">
                <label for="contact_email" class="question-label">{{ strings.contact_label }}</label>
                <input type="email" id="contact_email" name="contact_email" placeholder="{{ strings.contact_placeholder }}">
                <p><strong>{{ strings.privacy_note_strong }}</strong> {{ strings.privacy_note_text }}</p>
            </div>

            <button type="submit" id="submit-btn" class="btn-submit">{{ strings.button_text }}</button>
            <p id="error-message" class="error-message" style="display: none;"></p>
        </form>
    </div>
</div>

<script>
    // --- MODIFIED: Step index updated ---
    // const CURRENT_STEP_INDEX = 5; // (OLD)
    const CURRENT_STEP_INDEX = 9; // (NEW) OPEN_ENDED_QS is now step 9
    const CURRENT_STEP_NAME = "OPEN_ENDED_QS"; // (Unchanged)

    const form = document.getElementById('open-ended-form');
    const submitButton = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const interviewYes = document.getElementById('interview_yes');
    const interviewNo = document.getElementById('interview_no'); // Get the 'No' radio too
    const contactSection = document.getElementById('contact-section');
    const contactEmailInput = document.getElementById('contact_email');

    // --- JS Localization (using defaults for safety) ---
    const ERROR_FILL_ALL_HIGHLIGHTED = '{{ strings.error_fill_all | default("Please answer all required questions (marked with * or highlighted).", true) | safe }}';
    const LOADING_TEXT = '{{ strings.saving_data | default("Saving Data...", true) }}';
    const FINISH_TEXT = '{{ strings.button_text | default("Finish Questionnaire & View Debriefing", true) }}';
    const ERROR_UNKNOWN_SAVE = '{{ strings.error_unknown_data_save | default("Unknown error during data save.", true) }}';
    const ERROR_PID_MISSING = '{{ strings.error_pid_missing | default("Error: PID missing.", true) }}';

    // 确保从 Session Storage 中获取 participant_id
    const participantId = sessionStorage.getItem('participant_id');

    if (!participantId) {
        errorMessage.textContent = ERROR_PID_MISSING;
        errorMessage.style.display = 'block';
        submitButton.disabled = true;
        setTimeout(() => {
            window.location.href = '/html/admin_setup.html';
        }, 3000);
    }

    // 监听访谈意愿，显示/隐藏邮箱输入框
    form.addEventListener('change', function(event) {
        if (event.target.name === 'interview_consent') {
            if (interviewYes.checked) {
                contactSection.style.display = 'block';
                contactEmailInput.required = true; // Only required if 'Yes' is checked
            } else {
                contactSection.style.display = 'none';
                contactEmailInput.required = false;
                contactEmailInput.value = ''; // Clear email if user selects 'No'
                // Clear potential error states if 'No' is selected
                contactEmailInput.classList.remove('input-error');
                 const emailLabel = form.querySelector('label[for="contact_email"]');
                 if (emailLabel) emailLabel.classList.remove('label-error');
                 clearMainErrorIfNoInputErrors(); // Check if main error can be hidden
            }
             // Clear error from the radio group itself when a selection is made
             const radioGroupDiv = interviewYes.closest('.form-group');
             if (radioGroupDiv) {
                radioGroupDiv.classList.remove('group-error');
                const radioLabel = radioGroupDiv.querySelector('.question-label');
                if(radioLabel) radioLabel.classList.remove('label-error');
             }
             clearMainErrorIfNoInputErrors();
        }
    });

    // --- Helper to clear main error if no inputs have errors ---
    function clearMainErrorIfNoInputErrors() {
        if (!form.querySelector('.input-error, .label-error, .group-error')) {
            errorMessage.style.display = 'none';
        }
    }


    // --- Function to clear all error highlights ---
    function clearErrors() {
        errorMessage.style.display = 'none';
        form.querySelectorAll('.input-error, .label-error').forEach(el => {
            el.classList.remove('input-error', 'label-error');
        });
         form.querySelectorAll('.form-group.group-error').forEach(el => {
            el.classList.remove('group-error');
        });
    }

    // --- Function to add error highlight ---
    function addError(identifier, isGroupName = false) {
        let element;
        let labelElement;
        let containerElement;

        if (isGroupName) {
            // Find the first radio button in the group to locate the container
            element = form.querySelector(`input[name="${identifier}"]`);
            if (!element) return false;
            containerElement = element.closest('.form-group'); // Get the parent div
            // Try to find the label associated with the group
            labelElement = containerElement?.querySelector('.question-label');
            if (containerElement) containerElement.classList.add('group-error'); // Highlight the container

        } else {
            element = document.getElementById(identifier);
            if (!element) return false;
            containerElement = element.closest('.form-group'); // Get the parent div
            labelElement = form.querySelector(`label[for="${identifier}"]`);
            element.classList.add('input-error'); // Highlight the input itself
        }

        // Highlight the label if found
        if (labelElement) {
            labelElement.classList.add('label-error');
        } else if (containerElement) {
             // If no specific label, try highlighting the generic label in the container
            const genericLabel = containerElement.querySelector('.question-label');
            if(genericLabel) genericLabel.classList.add('label-error');
        }
        return false; // Indicate validation failed
    }


    form.addEventListener('submit', function(event) {
        event.preventDefault();
        clearErrors(); // Clear previous errors first

        const formData = new FormData(form);
        const data = {}; // For main questionnaire data
        const contactData = {}; // For separate contact info saving
        let isFormValid = true;

        // --- VALIDATION LOGIC ---
        // 1. Collect all fields, including optional text areas
        data.feedback_trust = formData.get('feedback_trust')?.trim() || "";
        data.feedback_empathy = formData.get('feedback_empathy')?.trim() || "";
        data.feedback_general = formData.get('feedback_general')?.trim() || "";
        data.interview_consent = formData.get('interview_consent'); // Required radio button
        const contactEmail = formData.get('contact_email')?.trim();

        // 2. Validate required fields
        // Check interview_consent radio group
        if (!data.interview_consent) {
             isFormValid = addError('interview_consent', true); // Highlight the radio group
        }

        // Check contact_email ONLY if interview_consent is 'Yes'
        if (data.interview_consent === 'Yes') {
            if (!contactEmail) {
                isFormValid = addError('contact_email'); // Highlight email input
            } else {
                // Optional: Basic email format validation
                if (!/^\S+@\S+\.\S+$/.test(contactEmail)) {
                    console.warn("Invalid email format entered.");
                    isFormValid = addError('contact_email'); // Treat invalid format as error
                } else {
                    contactData.email = contactEmail; // Prepare email for separate saving
                }
            }
        }
        // --- END VALIDATION LOGIC ---

        // If validation failed, show error and stop
        if (!isFormValid) {
             errorMessage.textContent = ERROR_FILL_ALL_HIGHLIGHTED;
             errorMessage.style.display = 'block';
             // Scroll to the first error
             const firstError = form.querySelector('.input-error, .group-error');
             if (firstError) {
                 // Scroll the container into view if it's a group error
                 const elementToScroll = firstError.classList.contains('form-group') ? firstError : firstError.closest('.form-group');
                 if(elementToScroll) {
                    elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 }
             }
             return;
        }

        // --- Validation passed, proceed with submission ---
        submitButton.disabled = true;
        submitButton.textContent = LOADING_TEXT;

        let mainApiData; // To store result of the first fetch

        // 1. Submit main data (all fields)
        fetch('http://127.0.0.1:5000/save_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                participant_id: participantId,
                step_name: CURRENT_STEP_NAME, // "OPEN_ENDED_QS"
                data: data, // Includes all feedback and consent
                current_step_index: CURRENT_STEP_INDEX // 9
            })
        })
        .then(response => response.json())
        .then(apiData => {
            mainApiData = apiData;
            if (!mainApiData.success) {
                throw new Error(mainApiData.error || ERROR_UNKNOWN_SAVE);
            }

            // 2. If consent was 'Yes' and email is valid, submit contact info separately
            if (data.interview_consent === 'Yes' && contactData.email) {
                console.log("Submitting contact info separately:", contactData.email);
                return fetch('http://127.0.0.1:5000/save_contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ participant_id: participantId, email: contactData.email })
                }).then(res => res.json()); // Chain the promise
            } else {
                // If no contact info to save, resolve immediately
                return Promise.resolve({ success: true });
            }
        })
        .then(contactApiData => {
            // Check success of contact saving, but proceed regardless
            if (!contactApiData || !contactApiData.success) {
                 console.warn("Failed to save contact info, but proceeding:", contactApiData?.error);
            } else if (data.interview_consent === 'Yes' && contactData.email) {
                 console.log("Contact info saved successfully.");
            }

            // Navigate to the next step (Debrief) from the main API response
            window.location.href = mainApiData.next_url;
        })
        .catch(error => {
            console.error('Data save error:', error);
            errorMessage.textContent = `Error: ${error.message}`;
            errorMessage.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = FINISH_TEXT;
        });
    });

    // --- Add event listeners to remove errors on input/change ---
     form.querySelectorAll('textarea, input[type="email"], input[type="radio"]').forEach(input => {
        const eventType = (input.type === 'radio') ? 'change' : 'input';
        input.addEventListener(eventType, () => {
             // Clear errors on the specific input or group
             if (input.type === 'radio') {
                 const groupName = input.name;
                 const groupContainer = input.closest('.form-group');
                 if (groupContainer) {
                     groupContainer.classList.remove('group-error');
                     const groupLabel = groupContainer.querySelector('.question-label');
                     if (groupLabel) groupLabel.classList.remove('label-error');
                 }
             } else {
                 input.classList.remove('input-error');
                 const label = form.querySelector(`label[for="${input.id}"]`);
                 if (label) label.classList.remove('label-error');
             }
             // Hide main error message if all errors are cleared
             clearMainErrorIfNoInputErrors();
        });
    });

</script>

</body>
</html>