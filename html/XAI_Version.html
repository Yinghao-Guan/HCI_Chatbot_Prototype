<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- This meta tag tells search engines not to index this page -->
    <meta name="robots" content="noindex, nofollow">
    <title>Chat Interface</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Peter Guan" />
    <link rel="manifest" href="/assets/site.webmanifest" />

    <style>
        /* --- CSS Styles --- */

        /* Basic page reset and font settings */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
        }

        /* Main layout container */
        #main-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Left Column: Chat window container */
        #chat-container {
            flex: 2; /* Takes up 2/3 of the space */
            min-width: 400px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Right Column: Side panel */
        #right-panel {
            flex: 1; /* Takes up 1/3 of the space */
            min-width: 300px;
            background-color: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        /* --- Chat Specific Styles (Left Column) --- */
        #chat-log {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-in-out;
        }

        .message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0;
        }

        .message .content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .ai-message { align-self: flex-start; }
        .ai-message .avatar { background-color: #6a5acd; }
        .ai-message .content { background-color: #f1f0f0; color: #333; border-top-left-radius: 4px; }

        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .avatar { background-color: #007bff; }
        .user-message .content { background-color: #007bff; color: #ffffff; border-top-right-radius: 4px; }

        #chat-form {
            display: flex;
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
        }

        #user-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 24px;
            resize: none;
            font-size: 16px;
            margin-right: 12px;
            font-family: inherit;
        }
        #user-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        #chat-form button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #chat-form button:hover { background-color: #0056b3; }
        #chat-form button:disabled { background-color: #a0c3e8; cursor: not-allowed; }

        /* --- Right Panel Specific Styles --- */
        #emoji-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        #emoji-display {
            font-size: 100px;
            margin-bottom: 20px;
            line-height: 1;
        }

        #emoji-controls {
            display: flex;
            gap: 15px;
        }

        .emoji-btn {
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .emoji-btn:hover {
            background-color: #dee2e6;
        }

        .emoji-btn:active {
            transform: scale(0.9);
        }

        #text-section p {
            margin: 0;
            line-height: 1.7;
            color: #495057;
        }

        /* Message fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<!-- --- HTML Structure --- -->
<div id="main-layout">
    <!-- Left Column -->
    <div id="chat-container">
        <div id="chat-log">
            <div class="message ai-message">
                <div class="avatar">AI</div>
                <div class="content">
                    <p>Hello! How can I help you today? Ask me anything below.</p>
                </div>
            </div>
        </div>
        <form id="chat-form">
            <textarea id="user-input" placeholder="Type a message..." rows="1" required></textarea>
            <button type="submit" title="Send">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
            </button>
        </form>
    </div>

    <!-- Right Column -->
    <div id="right-panel">
        <div id="emoji-section">
            <div id="emoji-display">ğŸ˜Š</div>
            <div id="emoji-controls">
                <button class="emoji-btn" title="Angry">ğŸ˜ </button>
                <button class="emoji-btn" title="Sad">ğŸ˜</button>
                <button class="emoji-btn" title="Crying">ğŸ˜­</button>
                <button class="emoji-btn" title="Neutral">ğŸ˜</button>
                <button class="emoji-btn" title="Happy">ğŸ˜Š</button>
            </div>
        </div>
        <div id="text-section">
            <h2>Here would be the output of XAI explanation.</h2><br>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </div>
    </div>
</div>

<script>
    // --- JavaScript Logic ---

    // --- Chat Logic (Left Column) ---
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatLog = document.getElementById('chat-log');
    const sendButton = chatForm.querySelector('button');

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const userText = userInput.value.trim();
        if (userText === '') return;

        // 1. Add the user's message (Fix: now renders as plain text)
        appendMessage(userText, 'user');

        userInput.value = '';
        userInput.style.height = 'auto';
        toggleSendButton();

        // 3. AI response (STREAMING + MARKDOWN)
        const aiParagraph = appendMessage('', 'ai');
        aiParagraph.innerHTML = 'â–‹'; // Typing cursor

        let totalResponseText = "";

        fetch('http://127.0.0.1:5000/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userText })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let isFirstChunk = true;

            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        return;
                    }
                    if (isFirstChunk) {
                        aiParagraph.innerHTML = ''; // Clear cursor
                        isFirstChunk = false;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    totalResponseText += chunk;

                    // AI response is parsed as Markdown
                    aiParagraph.innerHTML = marked.parse(totalResponseText);

                    chatLog.scrollTop = chatLog.scrollHeight;
                    readStream();
                }).catch(error => {
                    console.error('Error reading stream:', error);
                    aiParagraph.innerHTML += "<br>âš ï¸ è¯»å–å“åº”æµæ—¶å‡ºé”™ã€‚";
                });
            }
            readStream();
        })
        .catch(error => {
            console.error('Error:', error);
            aiParagraph.innerHTML = "âš ï¸ æœªèƒ½è¿æ¥åˆ°æœ¬åœ° AI åç«¯ã€‚";
        });
    });

    userInput.addEventListener('input', toggleSendButton);

    // --- FIX 2: ä¿®å¤è¾“å…¥æ³• (IME) æäº¤é—®é¢˜ ---
    userInput.addEventListener('keydown', function(event) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä»åœ¨ä½¿ç”¨è¾“å…¥æ³•ç»„åˆ
        if (event.isComposing) {
            return;
        }

        // å¦‚æœæŒ‰ä¸‹ Enter é”®ã€æ²¡æœ‰æŒ‰ Shift é”®ï¼Œå¹¶ä¸”ä¸åœ¨ç»„åˆçŠ¶æ€
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œ
            chatForm.dispatchEvent(new Event('submit')); // è§¦å‘æäº¤
        }
    });

    /**
     * MODIFIED Function to add a message to the chat log
     * @param {string} text - The message text
     * @param {string} sender - The sender ('user' or 'ai')
     * @returns {HTMLElement} - Returns the <p> element where text is stored
     */
    function appendMessage(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);

        const avatar = document.createElement('div');
        avatar.classList.add('avatar');
        avatar.textContent = sender === 'user' ? 'U' : 'AI';

        const content = document.createElement('div');
        content.classList.add('content');

        const textParagraph = document.createElement('p');

        // --- FIX 1: ä¿®å¤ç”¨æˆ·è¾“å…¥æ¸²æŸ“é—®é¢˜ ---
        if (sender === 'user') {
            // å°†ç”¨æˆ·è¾“å…¥è§†ä¸ºçº¯æ–‡æœ¬ï¼Œå¹¶æ›¿æ¢æ¢è¡Œç¬¦
            textParagraph.innerHTML = text.replace(/\n/g, '<br>');
        } else {
            // AI çš„è¾“å…¥ï¼ˆåˆå§‹ä¸ºç©ºæˆ–å…‰æ ‡ï¼‰
            textParagraph.innerHTML = text;
        }

        content.appendChild(textParagraph);
        messageElement.appendChild(avatar);
        messageElement.appendChild(content);
        chatLog.appendChild(messageElement);
        chatLog.scrollTop = chatLog.scrollHeight;

        return textParagraph;
    }

    function toggleSendButton() {
        sendButton.disabled = userInput.value.trim() === '';
    }

    toggleSendButton();

    // --- Emoji Logic (Right Column) ---
    const emojiDisplay = document.getElementById('emoji-display');
    const emojiButtons = document.querySelectorAll('.emoji-btn');

    emojiButtons.forEach(button => {
        button.addEventListener('click', () => {
            emojiDisplay.textContent = button.textContent;
        });
    });

</script>

</body>
</html>
