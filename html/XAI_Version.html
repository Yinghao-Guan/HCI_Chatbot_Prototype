<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- This meta tag tells search engines not to index this page -->
    <meta name="robots" content="noindex, nofollow">
    <title>Chat Interface</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Peter Guan" />
    <link rel="manifest" href="/assets/site.webmanifest" />

    <style>
        /* --- CSS Styles --- */

        /* Basic page reset and font settings */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #ffffff;
            color: #333;
            height: 100vh;
            overflow: hidden; /* Prevent body from scrolling */
        }

        /* Main layout container */
        #main-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Left Column: Chat window container */
        #chat-container {
            flex: 2; /* Takes up 2/3 of the space */
            min-width: 400px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Right Column: Side panel */
        #right-panel {
            flex: 1; /* Takes up 1/3 of the space */
            min-width: 300px;
            background-color: #f8f9fa;
            border-left: 1px solid #e0e0e0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        /* --- Chat Specific Styles (Left Column) --- */
        #chat-log {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease-in-out;
        }

        .message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            flex-shrink: 0;
        }

        .message .content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .ai-message { align-self: flex-start; }
        .ai-message .avatar { background-color: #6a5acd; }
        .ai-message .content { background-color: #f1f0f0; color: #333; border-top-left-radius: 4px; }

        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .avatar { background-color: #007bff; }
        .user-message .content { background-color: #007bff; color: #ffffff; border-top-right-radius: 4px; }

        #chat-form {
            display: flex;
            padding: 16px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
        }

        #user-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 24px;
            resize: none;
            font-size: 16px;
            margin-right: 12px;
            font-family: inherit;
        }
        #user-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        #chat-form button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #chat-form button:hover { background-color: #0056b3; }
        #chat-form button:disabled { background-color: #a0c3e8; cursor: not-allowed; }

        /* --- Right Panel Specific Styles --- */
        #emoji-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        #emoji-display {
            font-size: 100px;
            margin-bottom: 20px;
            line-height: 1;
        }

        #emoji-controls {
            display: flex;
            gap: 15px;
        }

        .emoji-btn {
            font-size: 28px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .emoji-btn:hover {
            background-color: #dee2e6;
        }

        .emoji-btn:active {
            transform: scale(0.9);
        }

        #text-section p {
            margin: 0;
            line-height: 1.7;
            color: #495057;
        }

        /* Message fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- New Styles for End Dialogue Button and Modal --- */

        /* Footer to contain input and end button */
        .chat-footer {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: #ffffff;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .end-dialogue-container {
            padding: 5px 0 10px 0;
        }

        .end-dialogue-button {
            width: 100%;
            padding: 10px;
            background-color: #e74c3c; /* çº¢è‰²æŒ‰é’® */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .end-dialogue-button:hover {
            background-color: #c0392b;
        }

        /* Modal Styles */
        .modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed;
            z-index: 1000; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex; /* ä½¿ç”¨ flex å±…ä¸­ */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #e74c3c;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        #confirm-end-btn {
            background-color: #e74c3c;
            color: white;
        }

        #cancel-end-btn {
            background-color: #bdc3c7;
            color: #333;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<!-- --- HTML Structure --- -->
<div id="main-layout">
    <!-- Left Column -->
    <div id="chat-container">
        <div id="chat-log">
            <div class="message ai-message">
                <div class="avatar">AI</div>
                <div class="content">
                    <p>Hello! How can I help you today? Ask me anything below.</p>
                </div>
            </div>
        </div>
        <div class="chat-footer">

            <div class="end-dialogue-container">
                <button type="button" id="end-dialogue-button" class="end-dialogue-button">
                    End Dialogue and Proceed to Questionnaire
                </button>
            </div>

            <form id="chat-form">
                <input type="text" id="user-input" placeholder="Type your message..." required>
                <button type="submit" id="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Right Column -->
    <div id="right-panel">
        <div id="emoji-section">
            <div id="emoji-display">ğŸ˜Š</div>
            <div id="emoji-controls">
                <button class="emoji-btn" title="Angry">ğŸ˜ </button>
                <button class="emoji-btn" title="Sad">ğŸ˜</button>
                <button class="emoji-btn" title="Crying">ğŸ˜­</button>
                <button class="emoji-btn" title="Neutral">ğŸ˜</button>
                <button class="emoji-btn" title="Happy">ğŸ˜Š</button>
            </div>
        </div>
        <div id="text-section">
            <h2>Here would be the output of XAI explanation.</h2><br>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </div>
    </div>
</div>

<div id="end-dialogue-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Confirm Dialogue End</h3>
        <p>Are you sure you want to end the conversation and proceed to the final questionnaires?</p>
        <p>Once ended, you <strong>cannot</strong> return to this chat.</p>
        <div class="modal-buttons">
            <button id="confirm-end-btn">Yes, End Dialogue</button>
            <button id="cancel-end-btn">No, Continue Chat</button>
        </div>
    </div>
</div>

<script>
    // --- JavaScript Logic ---

    // --- Chat Logic (Left Column) ---
    //const PARTICIPANT_ID = "TEMP_TEST_ID_001"; // <--- ä¸´æ—¶è®¾ç½®ä¸€ä¸ª ID
    // ç¡®ä¿ä» Session Storage ä¸­è·å– participant_id
    const participantId = sessionStorage.getItem('participant_id');

    if (!participantId) {
        // Fallback error handling if PID is missing (good practice)
        console.error("Participant ID not found in sessionStorage. Cannot proceed.");
        // å¯ä»¥æ·»åŠ  UI æç¤ºæˆ–é‡å®šå‘åˆ° admin_setup.html
    }

    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatLog = document.getElementById('chat-log');
    const sendButton = chatForm.querySelector('button');

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const userText = userInput.value.trim();
        if (userText === '') return;

        // Add the user's message (Fix: now renders as plain text)
        appendMessage(userText, 'user');

        userInput.value = '';
        userInput.style.height = 'auto';
        toggleSendButton();

        // AI response (STREAMING + MARKDOWN)
        const aiParagraph = appendMessage('', 'ai');
        aiParagraph.innerHTML = 'â–‹'; // Typing cursor

        let totalResponseText = "";

        // ç„¶åï¼Œä¿®æ”¹ chatForm.addEventListener('submit', ...) å†…éƒ¨çš„ fetch è°ƒç”¨ï¼š
        fetch('http://127.0.0.1:5000/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // ç¡®ä¿åœ¨ body ä¸­æ·»åŠ  participant_id
            body: JSON.stringify({
                message: userText,
                participant_id: participantId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let isFirstChunk = true;

            function readStream() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        return;
                    }
                    if (isFirstChunk) {
                        aiParagraph.innerHTML = ''; // Clear cursor
                        isFirstChunk = false;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    totalResponseText += chunk;

                    // AI response is parsed as Markdown
                    aiParagraph.innerHTML = marked.parse(totalResponseText);

                    chatLog.scrollTop = chatLog.scrollHeight;
                    readStream();
                }).catch(error => {
                    console.error('Error reading stream:', error);
                    aiParagraph.innerHTML += "<br>âš ï¸ è¯»å–å“åº”æµæ—¶å‡ºé”™ã€‚";
                });
            }
            readStream();
        })
        .catch(error => {
            console.error('Error:', error);
            aiParagraph.innerHTML = "âš ï¸ æœªèƒ½è¿æ¥åˆ°æœ¬åœ° AI åç«¯ã€‚";
        });
    });

    userInput.addEventListener('input', toggleSendButton);

    // --- è¾“å…¥æ³• (IME) æäº¤ ---
    userInput.addEventListener('keydown', function(event) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä»åœ¨ä½¿ç”¨è¾“å…¥æ³•ç»„åˆ
        if (event.isComposing) {
            return;
        }

        // å¦‚æœæŒ‰ä¸‹ Enter é”®ã€æ²¡æœ‰æŒ‰ Shift é”®ï¼Œå¹¶ä¸”ä¸åœ¨ç»„åˆçŠ¶æ€
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œ
            chatForm.dispatchEvent(new Event('submit')); // è§¦å‘æäº¤
        }
    });

    /**
     * MODIFIED Function to add a message to the chat log
     * @param {string} text - The message text
     * @param {string} sender - The sender ('user' or 'ai')
     * @returns {HTMLElement} - Returns the <p> element where text is stored
     */
    function appendMessage(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);

        const avatar = document.createElement('div');
        avatar.classList.add('avatar');
        avatar.textContent = sender === 'user' ? 'U' : 'AI';

        const content = document.createElement('div');
        content.classList.add('content');

        const textParagraph = document.createElement('p');

        // --- ç”¨æˆ·è¾“å…¥ä¸æ¸²æŸ“Markdown ---
        if (sender === 'user') {
            // å°†ç”¨æˆ·è¾“å…¥è§†ä¸ºçº¯æ–‡æœ¬ï¼Œå¹¶æ›¿æ¢æ¢è¡Œç¬¦
            textParagraph.innerHTML = text.replace(/\n/g, '<br>');
        } else {
            // AI çš„è¾“å…¥ï¼ˆåˆå§‹ä¸ºç©ºæˆ–å…‰æ ‡ï¼‰
            textParagraph.innerHTML = text;
        }

        content.appendChild(textParagraph);
        messageElement.appendChild(avatar);
        messageElement.appendChild(content);
        chatLog.appendChild(messageElement);
        chatLog.scrollTop = chatLog.scrollHeight;

        return textParagraph;
    }

    function toggleSendButton() {
        sendButton.disabled = userInput.value.trim() === '';
    }

    toggleSendButton();

    // --- Emoji Logic (Right Column) ---
    const emojiDisplay = document.getElementById('emoji-display');
    const emojiButtons = document.querySelectorAll('.emoji-btn');

    emojiButtons.forEach(button => {
        button.addEventListener('click', () => {
            emojiDisplay.textContent = button.textContent;
        });
    });

    // --- New Dialogue Termination Logic ---

    const endDialogueButton = document.getElementById('end-dialogue-button');
    const endDialogueModal = document.getElementById('end-dialogue-modal');
    const confirmEndButton = document.getElementById('confirm-end-btn');
    const cancelEndButton = document.getElementById('cancel-end-btn');

    // Show modal when the end button is clicked
    endDialogueButton.addEventListener('click', () => {
        endDialogueModal.style.display = 'flex'; // Use flex to show the modal
    });

    // Hide modal when the cancel button is clicked
    cancelEndButton.addEventListener('click', () => {
        endDialogueModal.style.display = 'none';
    });

    // Hide modal if user clicks outside of the modal content
    window.addEventListener('click', (event) => {
        // æ£€æŸ¥ç‚¹å‡»äº‹ä»¶çš„ç›®æ ‡æ˜¯å¦æ˜¯ modal å®¹å™¨æœ¬èº« (è€Œä¸æ˜¯ modal-content)
        if (event.target === endDialogueModal) {
            endDialogueModal.style.display = 'none';
        }
    });

    // Final confirmation to end dialogue: Calls the backend
    confirmEndButton.addEventListener('click', async () => {
        confirmEndButton.disabled = true;
        confirmEndButton.textContent = 'Processing...';

        // ç¦ç”¨æ‰€æœ‰ UI äº¤äº’ä»¥é˜²æ­¢é‡å¤æäº¤æˆ–æ„å¤–æ“ä½œ
        const messageInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        messageInput.disabled = true;
        sendButton.disabled = true;
        endDialogueButton.disabled = true;

        try {
            // const participantId = sessionStorage.getItem('participant_id');

            // 1. è°ƒç”¨æ–°çš„åç«¯è·¯ç”±æ¥å®Œæˆå¯¹è¯å¹¶è·å–ä¸‹ä¸€ä¸ª URL
            const response = await fetch('http://127.0.0.1:5000/end_dialogue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    participant_id: participantId, // <--- ä½¿ç”¨å¤–éƒ¨è·å–çš„å˜é‡
                })
            });

            const apiData = await response.json();

            if (apiData.success) {
                // 2. é‡å®šå‘åˆ°ä¸‹ä¸€ä¸ªæ­¥éª¤ (Post-Questionnaire)
                window.location.href = apiData.next_url;
            } else {
                throw new Error(apiData.error || 'Unknown error during dialogue termination.');
            }

        } catch (error) {
            console.error('Dialogue End Error:', error);
            alert('An error occurred while ending the dialogue. Please contact the experimenter.');

            // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·é‡è¯•æˆ–å¯»æ±‚å¸®åŠ©
            messageInput.disabled = false;
            sendButton.disabled = false;
            endDialogueButton.disabled = false;
            confirmEndButton.disabled = false;
            confirmEndButton.textContent = 'Yes, End Dialogue';
            endDialogueModal.style.display = 'none';
        }
    });

</script>

</body>
</html>
