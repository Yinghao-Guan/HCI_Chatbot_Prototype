<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ strings.title }}</title>
    <link rel="icon" type="image/png" href="/assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Peter Guan" />
    <link rel="manifest" href="/assets/site.webmanifest" />

    <style>
        /* --- CSS Styles (Unchanged) --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }

        /* Main container to center the content */
        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            max-width: 900px;
            margin: 0 auto; /* Center container horizontally */
            text-align: left;
        }

        /* Form and Consent Content */
        .consent-section {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .consent-section h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .consent-section h3 {
            color: #3498db;
            margin-top: 20px;
        }

        /* Highlight box for PDF confirmation */
        .pdf-check {
            background-color: #fcecec;
            border: 2px solid #e74c3c;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 25px;
            text-align: center;
        }
        .pdf-check strong {
            color: #e74c3c;
        }


        .consent-text {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Checkbox Styling */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        #consent-checkbox {
            margin-top: 5px; /* Aligns checkbox with the top of the text */
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        /* Button styling */
        .btn-consent {
            display: block;
            width: 100%;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background-color: #2ecc71;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-consent:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-consent:disabled {
            background-color: #a0c3e8;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
        }

        /* Hidden PID for reference */
        #pid-display {
            font-size: 0.8rem;
            color: #999;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="consent-section">
        <h1>{{ strings.title }}</h1>

        <div class="pdf-check">
            <strong>IMPORTANT:</strong> {{ strings.pdf_important | safe }}
        </div>

        <div class="consent-text">
            <h3>{{ strings.title_h3 }}</h3>
            <p>{{ strings.procedure_summary | safe }}</p>
            <p>{{ strings.procedure_steps | safe }}</p>

            <h3>{{ strings.rights_title }}</h3>
            <ul>
                <li>{{ strings.voluntary_withdrawal | safe }}</li>
                <li>{{ strings.anonymity | safe }}</li>
                <li>{{ strings.disclaimer | safe }}</li>
            </ul>

            <h3>{{ strings.confidentiality_title }}</h3>
            <p>{{ strings.confidentiality_text }}</p>

        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="consent-checkbox">
            <label for="consent-checkbox">
                {{ strings.checkbox_label }}
            </label>
        </div>

        <button id="consent-btn" class="btn-consent" disabled>{{ strings.button_text }}</button>
        <p id="error-message" class="error-message" style="display: none;"></p>
        <p id="pid-display">Participant ID: Loading...</p>
    </div>
</div>

<script>
    const CONSENT_STEP_INDEX = -1;
    const CONSENT_STEP_NAME = "CONSENT_AGREEMENT";

    const consentButton = document.getElementById('consent-btn');
    const consentCheckbox = document.getElementById('consent-checkbox');
    const errorMessage = document.getElementById('error-message');
    const pidDisplay = document.getElementById('pid-display');

    let participantId = null;

    // --- JS Localization Fix ---
    // Extract localized strings into JS variables
    const ERROR_PID_MISSING = '{{ strings.error_pid_missing }}';
    const ERROR_CHECKBOX = '{{ strings.checkbox_error }}';
    const LOADING_TEXT = '{{ strings.saving_data }}'.replace('Saving Data', 'Saving Consent');

    // --- Initialization and PID Check ---
    function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        participantId = urlParams.get('pid');

        if (!participantId) {
            // If no PID, redirect to Admin Setup
            pidDisplay.textContent = ERROR_PID_MISSING.replace('Please start over.', 'Redirecting to setup...');
            pidDisplay.style.color = 'red';
            setTimeout(() => {
                window.location.href = '/html/admin_setup.html';
            }, 3000);
            return false;
        }

        pidDisplay.textContent = `Participant ID: ${participantId}`;
        sessionStorage.setItem('participant_id', participantId); // Store PID for subsequent pages
        return true;
    }

    // Enable/Disable button based on checkbox
    consentCheckbox.addEventListener('change', function() {
        consentButton.disabled = !this.checked;
    });

    consentButton.addEventListener('click', function(event) {
        event.preventDefault();

        if (!participantId) {
            errorMessage.textContent = ERROR_PID_MISSING.replace('Please start over.', 'Session not initialized. Please restart from Admin Setup.');
            errorMessage.style.display = 'block';
            return;
        }

        if (!consentCheckbox.checked) {
            errorMessage.textContent = ERROR_CHECKBOX;
            errorMessage.style.display = 'block';
            return;
        }

        // Disable button and show loading state
        consentButton.disabled = true;
        consentButton.textContent = LOADING_TEXT;
        errorMessage.style.display = 'none';

        // 1. Call backend route to record user consent data
        fetch('http://127.0.0.1:5000/save_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                participant_id: participantId,
                step_name: CONSENT_STEP_NAME, // Step name: CONSENT_AGREEMENT
                data: {
                    consent_given: true,
                    time_on_page: new Date().getTime() // Record timestamp for time on page calc
                },
                current_step_index: CONSENT_STEP_INDEX // Next step index: 0 (DEMOGRAPHICS)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 2. Redirect to the next page (Demographics)
                window.location.href = data.next_url;
            } else {
                // Fallback to localized error message
                const errorText = data.error || '{{ strings.error_unknown_data_save }}';
                throw new Error(errorText);
            }
        })
        .catch(error => {
            console.error('Consent save error:', error);
            errorMessage.textContent = `Error: ${error.message}`;
            errorMessage.style.display = 'block';
            consentButton.disabled = false;
            consentButton.textContent = '{{ strings.button_text }}';
        });
    });

    // Page start, check PID
    initializePage();
</script>

</body>
</html>